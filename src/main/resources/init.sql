CREATE TABLE if not exists TEACHER(
  TEACHER_ID INTEGER PRIMARY KEY,
  NAME       VARCHAR(30) NOT NULL,
  POSITION   VARCHAR(40));

CREATE TABLE if not exists SUBJECT(
   SUBJECT_ID serial PRIMARY KEY,
   NAME       VARCHAR(30));

 
CREATE TABLE if not exists CLASS(
   CLASS_ID serial PRIMARY KEY,
   GRADE    INTEGER,
   NAME     VARCHAR(30));
 
CREATE TABLE if not exists PUPIL(
   PUPIL_ID INTEGER PRIMARY KEY,
   CLASS_ID INTEGER,
   NAME     VARCHAR(30),
   FOREIGN KEY (CLASS_ID) 
   REFERENCES CLASS (CLASS_ID));


CREATE TABLE if not exists SCHOOL_YEAR(
   SCHOOL_YEAR_ID serial PRIMARY KEY,
   NAME        VARCHAR(100),
   START_DATE  DATE,
   END_DATE    DATE);

CREATE TABLE if not exists SEMESTER(
   SEMESTER_ID    serial PRIMARY KEY,
   SCHOOL_YEAR_ID INTEGER,
   NAME           VARCHAR(100),
   START_DATE     DATE,
   END_DATE       DATE,
   FOREIGN KEY (SCHOOL_YEAR_ID)
   REFERENCES SCHOOL_YEAR (SCHOOL_YEAR_ID) ON DELETE CASCADE);

CREATE TABLE if not exists SUBJECT_DETAILS(
   SUBJECT_DETAILS_ID serial PRIMARY KEY,
   CLASS_ID           INTEGER,
   TEACHER_ID         INTEGER,
   SUBJECT_ID         INTEGER,
   SEMESTER_ID        INTEGER,
   CONSTRAINT SUBJECT_DETAILS_UNIQUE UNIQUE (CLASS_ID, SUBJECT_ID, SEMESTER_ID),
   FOREIGN KEY (CLASS_ID) 
   REFERENCES CLASS (CLASS_ID) ON DELETE CASCADE,
   FOREIGN KEY (TEACHER_ID) 
   REFERENCES TEACHER (TEACHER_ID) ON DELETE CASCADE,
   FOREIGN KEY (SUBJECT_ID) 
   REFERENCES SUBJECT (SUBJECT_ID) ON DELETE CASCADE,
   FOREIGN KEY (SEMESTER_ID)
   REFERENCES SEMESTER (SEMESTER_ID) ON DELETE CASCADE);
 
CREATE TABLE if not exists THEME(
   THEME_ID           serial PRIMARY KEY,
   SUBJECT_DETAILS_ID INTEGER,
   NAME               VARCHAR(100),
   FOREIGN KEY (SUBJECT_DETAILS_ID)
   REFERENCES SUBJECT_DETAILS (SUBJECT_DETAILS_ID) ON DELETE CASCADE);

CREATE TABLE if not exists LESSON(
   LESSON_ID   serial PRIMARY KEY,
   THEME_ID    INTEGER,
   LESSON_DATE DATE,
   TOPIC       VARCHAR(100),
   FOREIGN KEY (THEME_ID)
   REFERENCES THEME (THEME_ID) ON DELETE CASCADE);
 
CREATE TABLE if not exists MARK(
   MARK_ID   serial PRIMARY KEY,
   PUPIL_ID  INTEGER,
   LESSON_ID INTEGER,
   MARK      INTEGER,
   CONSTRAINT MARK_UNIQUE UNIQUE (PUPIL_ID, LESSON_ID),
   FOREIGN KEY (PUPIL_ID) 
   REFERENCES PUPIL (PUPIL_ID) ON DELETE CASCADE,
   FOREIGN KEY (LESSON_ID) 
   REFERENCES LESSON (LESSON_ID) ON DELETE CASCADE);
 
CREATE TABLE if not exists GRADEBOOK_USER(
   USER_ID  serial primary key,
   USERNAME VARCHAR(50),
   PASSWORD VARCHAR(200));
INSERT INTO GRADEBOOK_USER
VALUES (0, 'ADMIN', '$2a$10$ADnVWXeK4NXJqMGbgU4qv.m9npqvxRIu7LR1fzjCLMa5UNuvHZakC') ON CONFLICT DO NOTHING;

CREATE TABLE if not exists ROLE(
   ROLE_ID  INTEGER primary key,
   NAME     VARCHAR(20));
INSERT INTO ROLE VALUES (1, 'ADMIN') ON CONFLICT DO NOTHING;
INSERT INTO ROLE VALUES (2, 'TEACHER') ON CONFLICT DO NOTHING;
INSERT INTO ROLE VALUES (3, 'PUPIL') ON CONFLICT DO NOTHING;


CREATE TABLE if not exists USER_ROLE(
   USER_ID INTEGER,
   ROLE_ID INTEGER,
   CONSTRAINT USER_ROLE_UNIQUE UNIQUE (USER_ID, ROLE_ID),
   FOREIGN KEY (USER_ID)
   REFERENCES GRADEBOOK_USER (USER_ID) ON DELETE CASCADE,
   FOREIGN KEY (ROLE_ID)
   REFERENCES ROLE (ROLE_ID) ON DELETE CASCADE);
INSERT INTO USER_ROLE VALUES (0, 1) ON CONFLICT DO NOTHING;
